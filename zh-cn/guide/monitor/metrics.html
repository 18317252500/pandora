<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用和扩展 Metrics | Pandora.js</title>
    <meta name="description" content="一个可管理、可度量、可追踪的 Node.js 应用管理器">
    
    
    <link rel="preload" href="/pandora/assets/css/styles.d03d619b.css" as="style"><link rel="preload" href="/pandora/assets/js/app.d03d619b.js" as="script"><link rel="preload" href="/pandora/assets/js/46.2f26fa47.js" as="script"><link rel="prefetch" href="/pandora/assets/css/1.styles.505ab011.css"><link rel="prefetch" href="/pandora/assets/css/2.styles.7e0097fc.css"><link rel="prefetch" href="/pandora/assets/css/3.styles.727b3904.css"><link rel="prefetch" href="/pandora/assets/js/10.fcc695d3.js"><link rel="prefetch" href="/pandora/assets/js/11.23e793c1.js"><link rel="prefetch" href="/pandora/assets/js/12.85e4393d.js"><link rel="prefetch" href="/pandora/assets/js/13.caae9292.js"><link rel="prefetch" href="/pandora/assets/js/14.ea2c4022.js"><link rel="prefetch" href="/pandora/assets/js/15.5e3460c7.js"><link rel="prefetch" href="/pandora/assets/js/16.b64ec62e.js"><link rel="prefetch" href="/pandora/assets/js/17.6e53a40b.js"><link rel="prefetch" href="/pandora/assets/js/18.08f30e22.js"><link rel="prefetch" href="/pandora/assets/js/19.1da78269.js"><link rel="prefetch" href="/pandora/assets/js/2.7e0097fc.js"><link rel="prefetch" href="/pandora/assets/js/20.db49729f.js"><link rel="prefetch" href="/pandora/assets/js/21.73c4f5fb.js"><link rel="prefetch" href="/pandora/assets/js/22.8778cb9d.js"><link rel="prefetch" href="/pandora/assets/js/23.be09579b.js"><link rel="prefetch" href="/pandora/assets/js/24.4e082834.js"><link rel="prefetch" href="/pandora/assets/js/25.b0f5a9d8.js"><link rel="prefetch" href="/pandora/assets/js/26.887555f4.js"><link rel="prefetch" href="/pandora/assets/js/27.acf9dd16.js"><link rel="prefetch" href="/pandora/assets/js/28.1f69f226.js"><link rel="prefetch" href="/pandora/assets/js/29.b07c3474.js"><link rel="prefetch" href="/pandora/assets/js/3.727b3904.js"><link rel="prefetch" href="/pandora/assets/js/30.a3c6338d.js"><link rel="prefetch" href="/pandora/assets/js/31.e47f3723.js"><link rel="prefetch" href="/pandora/assets/js/32.2c313185.js"><link rel="prefetch" href="/pandora/assets/js/33.d389706b.js"><link rel="prefetch" href="/pandora/assets/js/34.f5c14c72.js"><link rel="prefetch" href="/pandora/assets/js/35.73ef8981.js"><link rel="prefetch" href="/pandora/assets/js/36.5b1a2521.js"><link rel="prefetch" href="/pandora/assets/js/37.e79f3ece.js"><link rel="prefetch" href="/pandora/assets/js/38.b350ad9d.js"><link rel="prefetch" href="/pandora/assets/js/39.5e797a6b.js"><link rel="prefetch" href="/pandora/assets/js/4.3950faea.js"><link rel="prefetch" href="/pandora/assets/js/40.fac5eb75.js"><link rel="prefetch" href="/pandora/assets/js/41.dca7e183.js"><link rel="prefetch" href="/pandora/assets/js/42.d1bfa6c8.js"><link rel="prefetch" href="/pandora/assets/js/43.64cd1d55.js"><link rel="prefetch" href="/pandora/assets/js/44.31cdf150.js"><link rel="prefetch" href="/pandora/assets/js/45.36e553b5.js"><link rel="prefetch" href="/pandora/assets/js/47.73424505.js"><link rel="prefetch" href="/pandora/assets/js/48.3f2bdd14.js"><link rel="prefetch" href="/pandora/assets/js/49.7cc1ba79.js"><link rel="prefetch" href="/pandora/assets/js/5.54bd7860.js"><link rel="prefetch" href="/pandora/assets/js/50.bd845095.js"><link rel="prefetch" href="/pandora/assets/js/51.92a0cf16.js"><link rel="prefetch" href="/pandora/assets/js/52.836cfe29.js"><link rel="prefetch" href="/pandora/assets/js/53.00a1fb25.js"><link rel="prefetch" href="/pandora/assets/js/54.387f0cb5.js"><link rel="prefetch" href="/pandora/assets/js/55.521a59b7.js"><link rel="prefetch" href="/pandora/assets/js/56.dbdb56c5.js"><link rel="prefetch" href="/pandora/assets/js/57.93a8468b.js"><link rel="prefetch" href="/pandora/assets/js/58.26888427.js"><link rel="prefetch" href="/pandora/assets/js/59.36eaf389.js"><link rel="prefetch" href="/pandora/assets/js/6.9c69e408.js"><link rel="prefetch" href="/pandora/assets/js/60.73ff8c0d.js"><link rel="prefetch" href="/pandora/assets/js/7.2ae26310.js"><link rel="prefetch" href="/pandora/assets/js/8.84c2fac1.js"><link rel="prefetch" href="/pandora/assets/js/9.24d982af.js"><link rel="prefetch" href="/pandora/assets/js/vendors~docsearch.505ab011.js">
    <link rel="stylesheet" href="/pandora/assets/css/1.styles.505ab011.css"><link rel="stylesheet" href="/pandora/assets/css/2.styles.7e0097fc.css"><link rel="stylesheet" href="/pandora/assets/css/3.styles.727b3904.css"><link rel="stylesheet" href="/pandora/assets/css/styles.d03d619b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/pandora/zh-cn/" class="home-link router-link-active"><!----> <span class="site-name">Pandora.js</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/pandora/zh-cn/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pandora/zh-cn/quickstart.html" class="nav-link">快速上手</a></div><div class="nav-item"><a href="/pandora/zh-cn/guide/introduce.html" class="nav-link">使用指南</a></div><div class="nav-item"><a href="/pandora/zh-cn/api.html" class="nav-link">API 接口</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">MidwayJs 系列产品</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/midway" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Midway - 面向未来的 Web 全栈框架
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>应用管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pandora/" class="nav-link">Pandora.js - Node.js 应用管理器</a></li></ul></li><li class="dropdown-item"><h4>监控产品</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pandora/zh-cn/guide/monitor/.html#" class="nav-link">Sandbox - 私有化 Node.js 监控产品</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pandora/guide/monitor/metrics.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/pandora/zh-cn/guide/monitor/metrics.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <a href="https://github.com/midwayjs/pandora" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/pandora/zh-cn/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pandora/zh-cn/quickstart.html" class="nav-link">快速上手</a></div><div class="nav-item"><a href="/pandora/zh-cn/guide/introduce.html" class="nav-link">使用指南</a></div><div class="nav-item"><a href="/pandora/zh-cn/api.html" class="nav-link">API 接口</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">MidwayJs 系列产品</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/midway" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Midway - 面向未来的 Web 全栈框架
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>应用管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pandora/" class="nav-link">Pandora.js - Node.js 应用管理器</a></li></ul></li><li class="dropdown-item"><h4>监控产品</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pandora/zh-cn/guide/monitor/.html#" class="nav-link">Sandbox - 私有化 Node.js 监控产品</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pandora/guide/monitor/metrics.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/pandora/zh-cn/guide/monitor/metrics.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <a href="https://github.com/midwayjs/pandora" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>概述</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/zh-cn/guide/introduce.html" class="sidebar-link">Pandora.js 是什么</a></li><li><a href="/pandora/zh-cn/guide/glossary.html" class="sidebar-link">关键术语</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>基础功能</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/zh-cn/guide/base/command.html" class="sidebar-link">命令行介绍</a></li><li><a href="/pandora/zh-cn/guide/other/dashboard.html" class="sidebar-link">可视化管理面板（Pandora-Dashboard）</a></li><li><a href="/pandora/zh-cn/guide/base/procfile_mode.html" class="sidebar-link">认识 procfile.js</a></li><li><a href="/pandora/zh-cn/guide/base/dorapan.html" class="sidebar-link">用户空间 SDK - Dorapan</a></li><li><a href="/pandora/zh-cn/guide/base/logs.html" class="sidebar-link">日志管理</a></li><li><a href="/pandora/zh-cn/guide/base/global_config.html" class="sidebar-link">全局配置</a></li><li><a href="/pandora/zh-cn/guide/base/quick_monitor.html" class="sidebar-link">快速了解监控</a></li><li><a href="/pandora/zh-cn/guide/base/debug.html" class="sidebar-link">调试应用</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>进程管理进阶</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/zh-cn/guide/process/process_std.html" class="sidebar-link">自定义进程</a></li><li><a href="/pandora/zh-cn/guide/process/service_std.html" class="sidebar-link">自定义 Service</a></li><li><a href="/pandora/zh-cn/guide/process/fork_and_cluster.html" class="sidebar-link">Fork 和 Cluster</a></li><li><a href="/pandora/zh-cn/guide/process/environment_std.html" class="sidebar-link">自定义环境（Environment）</a></li><li><a href="/pandora/zh-cn/guide/process/application_life_cycle.html" class="sidebar-link">应用生命周期</a></li><li><a href="/pandora/zh-cn/guide/process/ipc_hub.html" class="sidebar-link">进程间通信</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>应用监控</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/zh-cn/guide/monitor/monitor_std.html" class="sidebar-link">监控体系总览</a></li><li><a href="/pandora/zh-cn/guide/monitor/resource.html" class="sidebar-link">对外暴露的 Restful API</a></li><li><a href="/pandora/zh-cn/guide/monitor/trace.html" class="sidebar-link">链路追踪及监控</a></li><li><a href="/pandora/zh-cn/guide/monitor/monitor_inner.html" class="sidebar-link">一些默认监控</a></li><li><a href="/pandora/zh-cn/guide/monitor/endpoint.html" class="sidebar-link">使用和扩展 EndPoint</a></li><li><a href="/pandora/zh-cn/guide/monitor/metrics.html" class="active sidebar-link">使用和扩展 Metrics</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pandora/zh-cn/guide/monitor/metrics.html#快速使用" class="sidebar-link">快速使用</a></li><li class="sidebar-sub-header"><a href="/pandora/zh-cn/guide/monitor/metrics.html#指标的名字-metricname" class="sidebar-link">指标的名字 MetricName</a></li><li class="sidebar-sub-header"><a href="/pandora/zh-cn/guide/monitor/metrics.html#度量类型" class="sidebar-link">度量类型</a></li><li class="sidebar-sub-header"><a href="/pandora/zh-cn/guide/monitor/metrics.html#聚合型度量指标" class="sidebar-link">聚合型度量指标</a></li></ul></li><li><a href="/pandora/zh-cn/guide/monitor/report.html" class="sidebar-link">监控数据上报</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>监控数据采集</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/zh-cn/guide/collect/health.html" class="sidebar-link">健康检查</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>扩展功能</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/zh-cn/guide/other/typescript.html" class="sidebar-link">启动 TypeScript 项目</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="使用和扩展-metrics"><a href="#使用和扩展-metrics" aria-hidden="true" class="header-anchor">#</a> 使用和扩展 Metrics</h1> <p>Metrics 是监控里面比较大的一个体系，它基于 EndPoint 体系来传输数据，同时在这个基础上做了很多封装的工作。</p> <p>Metrics 的原意是 <strong>指标</strong>，用于反馈应用的当前状况的数据值，所以 Metrics 最后的结果都是<strong>数字</strong>。</p> <p>在业界标准的 Metrics 类型中，有几种标准的类型。</p> <ul><li>Gauge 瞬时值</li> <li>Counter 计数器</li> <li>Meter 吞吐率度量器</li> <li>Histogram 直方分布度量器</li></ul> <p>Pandora.js 目前对这几种度量器都做了一定的支持，这些度量器中最常用的就是 Gauge 和 Counter，可以说，80% 的场景都只是用这两种。</p> <h2 id="快速使用"><a href="#快速使用" aria-hidden="true" class="header-anchor">#</a> 快速使用</h2> <p>我们在每个进程启动时创建了一个 <code>MetricsClient</code> 客户端，但是用户怎么在代码中拿到这个对象就成了一个问题，我们设计了一个代理类 <code>MetricsClientUtil</code> ，只要用户希望，就可以在任意地方获取到这个类，比如：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>MetricsClientUtil<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dorapan'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> MetricsClientUtil<span class="token punctuation">.</span><span class="token function">getMetricsClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">let</span> counter <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test.qps.counter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> histogram <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getHistogram</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test.qps.histogram'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> meter <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getMeter</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test.qps.meter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> timer <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getTimer</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test.qps.timer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
counter<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
counter<span class="token punctuation">.</span><span class="token function">dec</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
histogram<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
meter<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过 <code>Client</code> 和 Get 对应的度量类型方法，这样在任意地方，用户都可以随时随地埋入 Metrics 指标，如果想知道埋入的效果，可以通过 <code>/metrics/:group</code> 这样的路由看到结果，更多的路由方法可以参考 <a href="/pandora/monitor/resource.html">Reource</a>。</p> <blockquote><p>注意：所有的 Metric 实例，都必须注册到当前进程的 MetricsClient 上才能被采集到。</p></blockquote> <p>由于 Gauge 指标的特殊性，Client 无法通过类似的 getGauge 方法创建 Gauge 类型的指标，所以有了通用的 <code>register()</code> 方法，定义如下，也可以<a href="http://www.midwayjs.org/pandora/api-reference/metrics/classes/metricsclient.html#register" target="_blank" rel="noopener noreferrer">查看 API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>client<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>group<span class="token punctuation">:</span> string<span class="token punctuation">,</span> name<span class="token punctuation">:</span> MetricName <span class="token operator">|</span> string<span class="token punctuation">,</span> Metric<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>根据定义，我们可以这样添加 Gauge 类型的指标。</p> <div class="language- extra-class"><pre class="language-text"><code>client.register('test', name, {
  getValue() {
  	return 100;
  }
});
</code></pre></div><h2 id="指标的名字-metricname"><a href="#指标的名字-metricname" aria-hidden="true" class="header-anchor">#</a> 指标的名字 MetricName</h2> <p>每一个指标都可以取一个名字，这个名字在 Pandora.js 并不是简单的字符串，而是一个 MetricName 类型的实现。</p> <p>这个类的属性参见 <a href="http://www.midwayjs.org/pandora/api-reference/metrics/classes/metricname.html" target="_blank" rel="noopener noreferrer">API 这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>常见的是 key 和 tags 两部分。</p> <p>key 就是标准的字符串，一般由几个字符串通过 . 来拼接而成。而 tags 是一组对象 kv 对，key 加 tags 标识了唯一的一个 Metric。</p> <h2 id="度量类型"><a href="#度量类型" aria-hidden="true" class="header-anchor">#</a> 度量类型</h2> <blockquote><p>目前 Pandora.js 全部使用 typescript 来编写，有些代码必须带类型定义。</p> <p>所有的 Metric 类型都继承与 <a href="http://www.midwayjs.org/pandora/api-reference/metrics/interfaces/metric.html" target="_blank" rel="noopener noreferrer">Metric 接口<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h3 id="瞬态型度量指标"><a href="#瞬态型度量指标" aria-hidden="true" class="header-anchor">#</a> 瞬态型度量指标</h3> <p>大部分的度量指标都从瞬态值 Gauge 介绍起，因为它最简单，最直观的表示数据的真实情况，也不涉及时间间隔的问题。</p> <p>Gauge 只包含一个 <code>getValue</code> 方法，只需要实现这个方法即可，比如，你想要知道当前进程的 cpu 使用情况，就可以一句话解决。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>BaseGauge<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">const</span> startUsage <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cpuUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> startUsage<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>注意，所有的 Metrics 最终输出的一定是数字形式，这样才可度量，如果你希望输出的是字符串类的信息，我们有另一套输出体系，这将在之后的文章介绍。</p></blockquote> <h3 id="累加型度量指标"><a href="#累加型度量指标" aria-hidden="true" class="header-anchor">#</a> 累加型度量指标</h3> <p>Counter 是第二个介绍的类型，计数器和 Gauge 不太一样，它是累加型，适用于记录调用总量等类型的数据，比如某个接口的调用次数。</p> <p>如下图是计数器的继承接口和实现类。</p> <p><img src="https://img.alicdn.com/tfs/TB1OkX3ldrJ8KJjSspaXXXuKpXa-780-732.png" alt></p> <p>除了基础的 <code>BaseCounter</code> 实现之外，我们提供了 <code>BucketCounter</code> 分桶计数器。</p> <p>分桶计数的原理是定义一个时间间隔，将一段时间按照时间间隔分割为几个桶，每个桶保存当前时间间隔的计数。</p> <p>比如时间间隔为 5s ，桶的总数为 10 个，那么 0~5s 为一个桶，5~10s 为下一个，以此类推。当计数的执行的时间为 2s 时，那么将在第一桶中累加，如果为 7s 时，那么将在第二个桶累加，非常容易理解。</p> <p>在实际场景中，因为内存限制，不宜保存过多，桶的量会有限制，采用环形队列存储同时避免数据的挪动。</p> <p>举个常用例子，记录 koa 服务的请求数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 实际使用需要从 MetricsClient 拿到 BucketCounter</span>
<span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BucketCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 累加 1 counter.inc(1);</span>
  counter<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="分布度量指标"><a href="#分布度量指标" aria-hidden="true" class="header-anchor">#</a> 分布度量指标</h3> <p>第三个介绍的是 Histogram，直方分布指标，Pandora.js 包含一个基础实现类 <code>BaseHistogram</code>， 通过它可以用于统计某个接口的响应时间，可以展示 50%, 70%, 90% 的请求响应时间落在哪个区间内，通过这些你可以计算出 <a href="https://en.wikipedia.org/wiki/Apdex" target="_blank" rel="noopener noreferrer">Apdex<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <blockquote><p>这边的分布暂时只考虑单机分布，在集群维度上不能这样计算。</p></blockquote> <p>对于分布计算，核心就是维护一个数据集 <a href="http://www.midwayjs.org/pandora/api-reference/metrics/enums/reservoirtype.html" target="_blank" rel="noopener noreferrer">Reservoir<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ，数据集用来提供数据存储以及获取当前快照的能力。这其中最重要的就是数据更新的策略，目前 Pandora.js 只实现了随机采样（UniformReservoir）和 指数衰减随机采样（ExponentiallyDecayingReservoir）的实现，由于随机采样并不能很好的表现权重问题，默认的是指数衰减随机采样，其他的采样算法没有实现，有兴趣的同学可以补充。</p> <p>举个常用例子，记录 koa 服务的成功比率，采用随机采样算法，间隔 1s，2个分桶，展示获取了平均数等信息。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 实际使用需要从 MetricsClient 拿到 BaseHistogram</span>
<span class="token keyword">let</span> histogram <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaseHistogram</span><span class="token punctuation">(</span>ReservoirType<span class="token punctuation">.</span><span class="token constant">UNIFORM</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  histogram<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  histogram<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// other biz</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// let snapshot = histogram.getSnapshot();</span>
<span class="token comment">// expect(snapshot.getMean()).to.equal(15);</span>
<span class="token comment">// expect(snapshot.getMax()).to.equal(20);</span>
<span class="token comment">// expect(snapshot.getMin()).to.equal(10);</span>
<span class="token comment">// expect(snapshot.getMedian()).to.equal(15);</span>
</code></pre></div><h3 id="变化速率度量指标"><a href="#变化速率度量指标" aria-hidden="true" class="header-anchor">#</a> 变化速率度量指标</h3> <p>第四个介绍的是 Meter，是一种用于度量一段时间内吞吐率的计量器。例如，一分钟内，五分钟内，十五分钟内的qps指标。</p> <p>这里要指出，变化的速率，我们一般情况下会关心两个地方，一个是瞬时爆发，超出平常正常值非常高的这样的波动变化，另一个是一段时间内的趋势，从平均的角度来看整体度量的一种方式，这种方式会将高低点进行平均来看。</p> <p>前一种在  Metrics 中使用  Rate 的概念，只记录事件的累计总次数，有外部系统来通过前后两次采集，来计算瞬时速率，这里我们称之为<code>Rate</code>。</p> <p>在rate的计算中，我们认为数据的增长是<code>线性</code>的。其计算方式为：rate = (v2 - v1) / (t2 - t1)，其中时间的单位是 s。</p> <p>这样的好处是，通过调整采集频率，可以支持任意时间间隔的瞬时速率计算。但缺点是，当两次采样之间系统重启的时候，会计算出负数，同时会有一部分数据丢失。</p> <p>后一种通过指数移动加权平均(Exponential Weighted Moving Average, EWMA）来计算。</p> <p>针对速率型度量指标，我们提供了1分钟(m1)，5分钟(m5)，15分钟的EWMA(m15)，分别用于反映距离当前时间点1分钟，5分钟，15分钟的速率变化。</p> <p>其具体的计算方法，和 Linux 系统中 load1, load5, load15 的计算方法完全一致。即，每 5 秒钟统计一次瞬时速率，并应用于如下的递推公式：</p> <div class="language- extra-class"><pre class="language-text"><code>EWMA(t) = EWMA(t-1) + alpha * (instantRate - EWMA(t-1))
</code></pre></div><p>其中 alpha取值范围为 0~1, 称为衰减系数，该系数越大，则距离当前的时间点越老的数据权重衰减的越快。</p> <p>举个常用例子，记录 koa 某个路由的调用比率。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 实际使用需要从 MetricsClient 拿到 BaseMeter</span>
<span class="token keyword">let</span> meter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaseMeter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 接口调用埋点</span>
  meter<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// meter.getMeanRate(); 总数除以时间</span>
<span class="token comment">// meter.getOneMinuteRate(); // 一分钟的 EWMA</span>
</code></pre></div><h2 id="聚合型度量指标"><a href="#聚合型度量指标" aria-hidden="true" class="header-anchor">#</a> 聚合型度量指标</h2> <p>这里引进一种特殊的指标，他相当于是多个指标的聚合。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> abstract <span class="token keyword">class</span> <span class="token class-name">MetricSet</span> <span class="token keyword">implements</span> <span class="token class-name">Metric</span> <span class="token punctuation">{</span>

  type<span class="token punctuation">:</span> string <span class="token operator">=</span> MetricType<span class="token punctuation">.</span><span class="token constant">METRICSET</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * A map of metric names to metrics.
   *
   * @return the metrics
   */</span>
  abstract <span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token punctuation">{</span>
    name<span class="token punctuation">,</span>
    metric
  <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>MetricSet 包含了一个抽象的 <code>getMetrics()</code> 方法，用于返回最终的多个 Metrics，我们利用它实现了一个上层 <code>CachedMetricSet</code>，用于将指标通过不同的 MetricsLevel 缓存一段时间。</p> <p>这里举个简单的例子：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">TestCachedMetricSet</span> <span class="token keyword">extends</span> <span class="token class-name">CachedMetricSet</span> <span class="token punctuation">{</span>

  caches<span class="token punctuation">;</span>

  <span class="token function">getValueInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>caches <span class="token operator">=</span> <span class="token punctuation">{</span>
      a<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      b<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> MetricName<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string">'test.a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      metric<span class="token punctuation">:</span> <span class="token operator">&lt;</span>BaseGauge<span class="token operator">&lt;</span>any<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">async</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> self<span class="token punctuation">.</span><span class="token function">refreshIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> self<span class="token punctuation">.</span>caches<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> MetricName<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string">'test.b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      metric<span class="token punctuation">:</span> <span class="token operator">&lt;</span>GaugeProxy<span class="token operator">&lt;</span>any<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">async</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> self<span class="token punctuation">.</span><span class="token function">refreshIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> self<span class="token punctuation">.</span>caches<span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> results<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>这里通过 <code>getMetrics()</code> 方法返回了两个 Gauge 指标，这两个指标通过内部缓存的值进行返回， <code>refreshIfNecessary()</code> 用于将内部的缓存值进行刷新操作。</p> <p>内置的大部分指标像 CPU、内存等等都是基于 <code>CachedMetricSet</code> 来实现的，更多的可以参考<a href="http://www.midwayjs.org/pandora/api-reference/metrics/classes/cpuusagegaugeset.html" target="_blank" rel="noopener noreferrer">代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>实现。</p> <blockquote><p>虽然注册时是一个指标，但是最后展示会进行分解，变成几个单独的指标</p></blockquote></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/midwayjs/pandora/edit/master/docs/zh-cn/guide/monitor/metrics.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2018-9-19 22:35:44</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pandora/zh-cn/guide/monitor/endpoint.html" class="prev">
          使用和扩展 EndPoint
        </a></span> <span class="next"><a href="/pandora/zh-cn/guide/monitor/report.html">
          监控数据上报
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/pandora/assets/js/46.2f26fa47.js" defer></script><script src="/pandora/assets/js/app.d03d619b.js" defer></script>
  </body>
</html>
