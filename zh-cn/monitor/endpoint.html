<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <title>使用和扩展 EndPoint - Ready to boot</title>
  <meta charset="utf-8">
  <meta name="description" content="index.description">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" href="/pandora/css/index.css">

</head>
<body>
  <div class="nav" >
  <header>
    <a href="/pandora/zh-cn" class="nav-logo leftpadding" alt="Pandora.js"><img src="/pandora/images/nav-logo.png" > Pandora.js</a>
    <ul class="nav-item">
      <li><a href="/pandora/zh-cn/introduce.html" alt="文档指南">文档指南</a></li><li><a href="/pandora/zh-cn/api.html" alt="API 接口">API 接口</a></li><li><a href="https://github.com/midwayjs/pandora/releases" alt="发布日志">发布日志</a></li>
      <!--
      <li class="translations">
        <a class="nav-link">header.translations</a>
        <span class="arrow"></span>
        <ul class="dropdown-content">
          <li><a href="/">中文</a></li>
          <li><a href="/">English</a></li>
        </ul>
      </li>
      -->
      <li><iframe src="https://ghbtns.com/github-btn.html?user=midwayjs&repo=pandora&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container" class="container">
    <div class="page-main">
  <article class="markdown-body">
    <h1>使用和扩展 EndPoint</h1>
    <p>EndPoint 是预埋在 Daemon 端的一组接收器，用于接收每个进程的 Indicator 数据，这些数据按照应用来分组。</p>
<p>在默认的场景下，我们会预埋一些 EndPoint，用户可以对这些东西全部自定义。</p>
<h2 id="endpoint-结构"><a class="markdown-anchor" href="#endpoint-结构">#</a> EndPoint 结构</h2>
<p>每个 EndPoint 都包含一个</p>
<h2 id="使用-endpoint-和-indicator"><a class="markdown-anchor" href="#使用-endpoint-和-indicator">#</a> 使用 EndPoint 和 Indicator</h2>
<p>一般来说，EndPoint 用户自定义概率不高，主要是 Indicator 需要埋入到业务脚本中。</p>
<p><strong>监控检查</strong></p>
<p>Pandora.js 提供了 <code>HealthEndPoint</code> 来做健康检查的能力，通过 <code>/health</code> 的路由即可访问。</p>
<p>默认我们提供了一些基础的检查，比如磁盘检查，端口检查等，如果需要修改其中的配置，可以在全局配置中进行覆盖调整。</p>
<p><code>HealthEndPoint</code> 有相应的客户端来负责采集数据， 我们提供了 <code>HealthIndicator</code> 这个基础抽象类，用户只要实现它就能把健康检查给统一起来。</p>
<p>比如你要检查当前的远程服务器是否可用，就可以实现其中的 <code>doCheck</code> 方法。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'HealthIndicator, HealthBuilder'</span> <span class="keyword">from</span> <span class="string">'pandora-metrics'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> cp <span class="keyword">from</span> <span class="string">'child_process'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteUrlHealthIndicator</span> <span class="keyword">extends</span> <span class="title">HealthIndicator</span> </span>&#123;</span><br><span class="line">  name = <span class="string">'remote_url'</span>;</span><br><span class="line"></span><br><span class="line">  doCheck(builder) &#123;</span><br><span class="line">    <span class="comment">// check remote</span></span><br><span class="line">    <span class="keyword">let</span> result = cp.execSync(<span class="string">`curl -s --connect-timeout 1 -o /dev/null -w "%&#123;http_code&#125;" http://google.com`</span>);</span><br><span class="line">    <span class="keyword">if</span> (result.toString() === <span class="string">'200'</span>) &#123;</span><br><span class="line">      builder.up();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      builder.down();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>doCheck</code> 方法中，我们传入了一个 builder，用来简化返回结果，通过 <code>builder.up()</code> 和 <code>builder.down()</code> 来返回成功和失败。</p>
<p>这样，你访问 <code>http://127.1:8006/health</code> 的时候，就能看到名为 <code>remote_url</code> 的健康检查结果了。</p>
<p>大概如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  status: &apos;UP&apos;,</span><br><span class="line">  remote_url: &#123;</span><br><span class="line">    status: &apos;UP&apos;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的格式是由 <code>HealthResource</code> 这个类定义的，健康检查看的是总体的一个结果，只要出现一个不正常，整体就不通过，所以 status 字段代表着总的一个状态，通过 'UP' 和 'DOWN' 来表示是否健康。</p>
<h2 id="定义-endpoint"><a class="markdown-anchor" href="#定义-endpoint">#</a> 定义 EndPoint</h2>
<p>每个 EndPoint 是一个 IPC 服务器，用于接收 Indicator 调用的结果，并进行汇总，最为常用的两个方法就是 <code>invoke</code> 和 <code>processQueryResults</code>，定义如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> interface IEndPoint &#123;</span><br><span class="line">  indicators: <span class="built_in">Array</span>&lt;IIndicator&gt;;</span><br><span class="line">  group: string;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 调用名下指标</span></span><br><span class="line"><span class="comment">   * @param appName</span></span><br><span class="line"><span class="comment">   * @param args</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  invoke(appName: string, args?: any);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理查询返回结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  processQueryResults(results?: <span class="built_in">Array</span>&lt;IIndicatorResult&gt;): any;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在代码内部我们使用了接口来进行定义，我们对 EndPoint 增加了一个 group 字段，这样 Indicator 只要配置里这个 group，就可以上报到同一个 EndPoint 上。</p>
<h2 id="定义-indicator"><a class="markdown-anchor" href="#定义-indicator">#</a> 定义 Indicator</h2>
<p>每个 Indicator 是一个 IPC 客户端，可以在不同的进程中初始化，我们使用 pid 作为区分，所以一般来说，一个进程只允许一个同名的 Indicator 存在，在 cluster 模式下，Indicator 就可以以多个的形式通过同一个 group 上报给 EndPoint。</p>
<p>Indicator 有几个重要的字段，和 EndPoint 类似，<code>group</code> 表示对应连接到哪个 EndPoint，而 <code>invoke</code> 方法则是真正的调用执行的地方。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 单个指标</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> interface IIndicator &#123;</span><br><span class="line">  group: string;</span><br><span class="line">  invoke(data?: any, builder?: IBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="一些配置约定"><a class="markdown-anchor" href="#一些配置约定">#</a> 一些配置约定</h2>
<p>不同版本的配置可能会有些增减，但是大致的配置如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  actuator: &#123;</span><br><span class="line">    endPoint: &#123;</span><br><span class="line">      error: &#123;</span><br><span class="line">        enabled: <span class="literal">true</span>,</span><br><span class="line">        target: ErrorEndPoint,</span><br><span class="line">        resource: ErrorResource,</span><br><span class="line">        initConfig: &#123;</span><br><span class="line">          maxErrorCount: <span class="number">100</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      health: &#123;</span><br><span class="line">        enabled: <span class="literal">true</span>,</span><br><span class="line">        target: HealthEndPoint,</span><br><span class="line">        resource: HealthResource,</span><br><span class="line">        initConfig: &#123;</span><br><span class="line">          port: &#123;</span><br><span class="line">            enabled: <span class="literal">true</span>,</span><br><span class="line">            checkUrl: <span class="string">`http://127.1:6001`</span></span><br><span class="line">          &#125;,</span><br><span class="line">          disk_space: &#123;</span><br><span class="line">            enabled: <span class="literal">true</span>,</span><br><span class="line">            rate: <span class="number">80</span>,</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      process: &#123;</span><br><span class="line">        enabled: <span class="literal">true</span>,</span><br><span class="line">        target: ProcessEndPoint,</span><br><span class="line">      &#125;,</span><br><span class="line">      metrics: &#123;</span><br><span class="line">        enabled: <span class="literal">true</span>,</span><br><span class="line">        target: MetricsEndPoint,</span><br><span class="line">        resource: MetricsResource</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>每个 EndPoint 都有几个通用的配置</p>
<ul>
<li>name {String} 名字，全局唯一就行</li>
<li>enabled {Boolean} 是否启用</li>
<li>target {IEndPoint} 对应的 EndPoint 类</li>
<li>resource {ActuatorResource} 对应的 Resource 类</li>
<li>initConfig {Object} 初始化配置</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">metrics: &#123;</span><br><span class="line">  enabled: <span class="literal">true</span>,</span><br><span class="line">  target: MetricsEndPoint,</span><br><span class="line">  resource: MetricsResource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上就是 EndPoint 的配置方法。</p>

  </article>
  <aside id="mobileAside" class="toc">
  <div class="mobile-menu">
    <ul><li><a href="/pandora/zh-cn/introduce.html" alt="文档指南">文档指南</a></li><li><a href="/pandora/zh-cn/api.html" alt="API 接口">API 接口</a></li><li><a href="https://github.com/midwayjs/pandora/releases" alt="发布日志">发布日志</a></li></ul>
  </div>
  <dl><dt><a href="/pandora/zh-cn/introduce.html">Pandora.js 是什么？</a></dt></ul></dd><dt><a href="/pandora/zh-cn/quickstart.html">快速入门</a></dt></ul></dd><dt><a href="/pandora/zh-cn/glossary.html">关键术语</a></dt></ul></dd><dt>基础功能</dt><dd><ul><li><a href="/pandora/zh-cn/base/command.html">命令行介绍</a></li><li><a href="/pandora/zh-cn/base/procfile_mode.html">认识 procfile.js</a></li><li><a href="/pandora/zh-cn/base/logs.html">日志管理</a></li><li><a href="/pandora/zh-cn/base/global_config.html">配置文件</a></li><li><a href="/pandora/zh-cn/base/quick_monitor.html">快速了解监控</a></li><li><a href="/pandora/zh-cn/base/debug.html">调试应用</a></li></ul></dd><dt>进程管理进阶</dt><dd><ul><li><a href="/pandora/zh-cn/process/process_std.html">自定义进程</a></li><li><a href="/pandora/zh-cn/process/service_std.html">自定义 Service</a></li><li><a href="/pandora/zh-cn/process/fork_and_cluster.html">Fork 和 Cluster</a></li><li><a href="/pandora/zh-cn/process/environment_std.html">自定义环境</a></li><li><a href="/pandora/zh-cn/process/application_life_cycle.html">应用生命周期</a></li><li><a href="/pandora/zh-cn/process/ipc_hub.html">进程间通信</a></li></ul></dd><dt>标准监控体系</dt><dd><ul><li><a href="/pandora/zh-cn/monitor/monitor_std.html">监控体系介绍</a></li><li><a href="/pandora/zh-cn/monitor/endpoint.html">使用和扩展 EndPoint</a></li><li><a href="/pandora/zh-cn/monitor/resource.html">对外暴露 Resource</a></li><li><a href="/pandora/zh-cn/monitor/metrics.html">使用和扩展 Metrics</a></li><li><a href="/pandora/zh-cn/monitor/trace.html">链路监控</a></li><li><a href="/pandora/zh-cn/monitor/monitor_inner.html">默认监控</a></li></ul></dd><dt>扩展功能</dt><dd><ul><li><a href="/pandora/zh-cn/other/dashboard.html">单机可视化管理面板</a></li><li><a href="/pandora/zh-cn/other/typescript.html">启动 TypeScript 项目</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');
mobileTrigger.onclick = function(e) {
  e.preventDefault();
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'toc';
  }
};
</script>

</div>

  </div>
</body>
<div class="cnzz">
<script src="https://s19.cnzz.com/z_stat.php?id=1271324644&web_id=1271324644" language="JavaScript"></script>
</div>

</html>
