<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Metrics Usage and Extension | Pandora.js</title>
    <meta name="description" content="A Manageable, Measurable and Traceable Node.js Application Manager">
    
    
    <link rel="preload" href="/pandora/assets/css/styles.e1a5d135.css" as="style"><link rel="preload" href="/pandora/assets/js/app.e1a5d135.js" as="script"><link rel="preload" href="/pandora/assets/js/16.beaa5f2a.js" as="script"><link rel="prefetch" href="/pandora/assets/js/29.3ccbef5f.js"><link rel="prefetch" href="/pandora/assets/css/1.styles.6b8612a2.css"><link rel="prefetch" href="/pandora/assets/js/1.6b8612a2.js"><link rel="prefetch" href="/pandora/assets/css/2.styles.7e0097fc.css"><link rel="prefetch" href="/pandora/assets/js/2.7e0097fc.js"><link rel="prefetch" href="/pandora/assets/js/3.960790bb.js"><link rel="prefetch" href="/pandora/assets/js/4.19ee1dcf.js"><link rel="prefetch" href="/pandora/assets/js/5.d8a19ae3.js"><link rel="prefetch" href="/pandora/assets/js/6.7382ca00.js"><link rel="prefetch" href="/pandora/assets/js/7.fa7c2def.js"><link rel="prefetch" href="/pandora/assets/js/8.fccf8cd3.js"><link rel="prefetch" href="/pandora/assets/js/9.46ee006a.js"><link rel="prefetch" href="/pandora/assets/js/10.e8921b17.js"><link rel="prefetch" href="/pandora/assets/js/11.adc68014.js"><link rel="prefetch" href="/pandora/assets/js/12.ee905cfd.js"><link rel="prefetch" href="/pandora/assets/js/13.9e2b9d2a.js"><link rel="prefetch" href="/pandora/assets/js/14.2d94cec5.js"><link rel="prefetch" href="/pandora/assets/js/15.ffc8d991.js"><link rel="prefetch" href="/pandora/assets/js/17.8870fc26.js"><link rel="prefetch" href="/pandora/assets/js/18.71014c7c.js"><link rel="prefetch" href="/pandora/assets/js/19.e85dd089.js"><link rel="prefetch" href="/pandora/assets/js/20.ed064cc5.js"><link rel="prefetch" href="/pandora/assets/js/21.e50f73cc.js"><link rel="prefetch" href="/pandora/assets/js/22.ff06e41b.js"><link rel="prefetch" href="/pandora/assets/js/23.a27b929c.js"><link rel="prefetch" href="/pandora/assets/js/24.8c6e1463.js"><link rel="prefetch" href="/pandora/assets/js/25.addadf02.js"><link rel="prefetch" href="/pandora/assets/js/26.76d48fab.js"><link rel="prefetch" href="/pandora/assets/js/27.878f4b14.js"><link rel="prefetch" href="/pandora/assets/js/28.c25bc094.js"><link rel="prefetch" href="/pandora/assets/js/30.b35d29c9.js"><link rel="prefetch" href="/pandora/assets/js/31.4964b80b.js"><link rel="prefetch" href="/pandora/assets/js/32.2afa22e1.js"><link rel="prefetch" href="/pandora/assets/js/33.c543e9cf.js"><link rel="prefetch" href="/pandora/assets/js/34.bbfa62e3.js"><link rel="prefetch" href="/pandora/assets/js/35.436c2031.js"><link rel="prefetch" href="/pandora/assets/js/36.2ffc7192.js"><link rel="prefetch" href="/pandora/assets/js/37.429fe621.js"><link rel="prefetch" href="/pandora/assets/js/38.cf3c476d.js"><link rel="prefetch" href="/pandora/assets/js/39.c92eba1d.js"><link rel="prefetch" href="/pandora/assets/js/40.23d4f431.js"><link rel="prefetch" href="/pandora/assets/js/41.134a4cbc.js"><link rel="prefetch" href="/pandora/assets/js/42.ba561931.js"><link rel="prefetch" href="/pandora/assets/js/43.890af0b8.js"><link rel="prefetch" href="/pandora/assets/js/44.16d7ee56.js"><link rel="prefetch" href="/pandora/assets/js/45.58e5d93b.js"><link rel="prefetch" href="/pandora/assets/js/46.b2120ce9.js"><link rel="prefetch" href="/pandora/assets/js/47.ff4e6462.js"><link rel="prefetch" href="/pandora/assets/js/48.5ef19a00.js"><link rel="prefetch" href="/pandora/assets/js/49.39c9e35f.js"><link rel="prefetch" href="/pandora/assets/js/50.c8bad3ef.js"><link rel="prefetch" href="/pandora/assets/js/51.33168cf8.js"><link rel="prefetch" href="/pandora/assets/js/52.52612d9b.js"><link rel="prefetch" href="/pandora/assets/js/53.e036bc55.js"><link rel="prefetch" href="/pandora/assets/js/54.73e8e247.js"><link rel="prefetch" href="/pandora/assets/js/55.f2d0c443.js"><link rel="prefetch" href="/pandora/assets/js/56.7842c24f.js"><link rel="prefetch" href="/pandora/assets/js/57.38184a7d.js"><link rel="prefetch" href="/pandora/assets/js/58.d52d303c.js"><link rel="prefetch" href="/pandora/assets/js/59.c64daee2.js"><link rel="prefetch" href="/pandora/assets/css/60.styles.bc02162c.css"><link rel="prefetch" href="/pandora/assets/js/vendors~docsearch.bc02162c.js">
    <link rel="stylesheet" href="/pandora/assets/css/1.styles.6b8612a2.css"><link rel="stylesheet" href="/pandora/assets/css/2.styles.7e0097fc.css"><link rel="stylesheet" href="/pandora/assets/css/styles.e1a5d135.css"><link rel="stylesheet" href="/pandora/assets/css/60.styles.bc02162c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/pandora/" class="home-link router-link-active"><!----> <span class="site-name">Pandora.js</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/pandora/" class="nav-link">Home</a></div><div class="nav-item"><a href="/pandora/quickstart.html" class="nav-link">Quick Start</a></div><div class="nav-item"><a href="/pandora/guide/introduce.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="/pandora/api.html" class="nav-link">API reference</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">MidwayJs Products</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Web Framework</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/midway" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Midway - Future-oriented web full stack framework
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>Application Management</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pandora/" class="nav-link">Pandora.js - Node.js Application Manager</a></li></ul></li><li class="dropdown-item"><h4>Node.js Monitoring Platform</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pandora/guide/monitor/.html#" class="nav-link">Sandbox - Privatized node. js monitoring product</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pandora/guide/monitor/metrics.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/pandora/zh-cn/guide/monitor/metrics.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/midwayjs/pandora" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/pandora/" class="nav-link">Home</a></div><div class="nav-item"><a href="/pandora/quickstart.html" class="nav-link">Quick Start</a></div><div class="nav-item"><a href="/pandora/guide/introduce.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="/pandora/api.html" class="nav-link">API reference</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">MidwayJs Products</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Web Framework</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/midway" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Midway - Future-oriented web full stack framework
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>Application Management</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pandora/" class="nav-link">Pandora.js - Node.js Application Manager</a></li></ul></li><li class="dropdown-item"><h4>Node.js Monitoring Platform</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pandora/guide/monitor/.html#" class="nav-link">Sandbox - Privatized node. js monitoring product</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pandora/guide/monitor/metrics.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/pandora/zh-cn/guide/monitor/metrics.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/midwayjs/pandora" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>Overview</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/guide/introduce.html" class="sidebar-link">What is Pandora.js</a></li><li><a href="/pandora/guide/glossary.html" class="sidebar-link">Glossary</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Basic Features</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/guide/base/command.html" class="sidebar-link">Commands</a></li><li><a href="/pandora/guide/other/dashboard.html" class="sidebar-link">GUI Dashboard ( Pandora-Dashboard )</a></li><li><a href="/pandora/guide/base/procfile_mode.html" class="sidebar-link">Understand procfile.js</a></li><li><a href="/pandora/guide/base/dorapan.html" class="sidebar-link">User SDK - Dorapan</a></li><li><a href="/pandora/guide/base/logs.html" class="sidebar-link">Log Management</a></li><li><a href="/pandora/guide/base/global_config.html" class="sidebar-link">Global Config</a></li><li><a href="/pandora/guide/base/quick_monitor.html" class="sidebar-link">Quickly Understand the Monitoring</a></li><li><a href="/pandora/guide/base/debug.html" class="sidebar-link">Debugging Application</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Advanced Processes Model</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/guide/process/process_std.html" class="sidebar-link">Custom Process</a></li><li><a href="/pandora/guide/process/service_std.html" class="sidebar-link">Custom service</a></li><li><a href="/pandora/guide/process/fork_and_cluster.html" class="sidebar-link">Fork and Cluster</a></li><li><a href="/pandora/guide/process/environment_std.html" class="sidebar-link">Application Environment</a></li><li><a href="/pandora/guide/process/application_life_cycle.html" class="sidebar-link">Application Life Cycle</a></li><li><a href="/pandora/guide/process/ipc_hub.html" class="sidebar-link">Inter-Process Communication Hub</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>Application Monitoring</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/guide/monitor/monitor_std.html" class="sidebar-link">Monitor System Overview</a></li><li><a href="/pandora/guide/monitor/resource.html" class="sidebar-link">Exposed RESTFul API</a></li><li><a href="/pandora/guide/monitor/trace.html" class="sidebar-link">Trace Each Requests</a></li><li><a href="/pandora/guide/monitor/monitor_inner.html" class="sidebar-link">Base Monitoring</a></li><li><a href="/pandora/guide/monitor/endpoint.html" class="sidebar-link">EndPoint Usage and Extension</a></li><li><a href="/pandora/guide/monitor/metrics.html" class="active sidebar-link">Metrics Usage and Extension</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pandora/guide/monitor/metrics.html#quick-use" class="sidebar-link">Quick use</a></li><li class="sidebar-sub-header"><a href="/pandora/guide/monitor/metrics.html#the-name-of-the-indicator-metricname" class="sidebar-link">The name of the indicator - MetricName</a></li><li class="sidebar-sub-header"><a href="/pandora/guide/monitor/metrics.html#measurement-type" class="sidebar-link">Measurement type</a></li><li class="sidebar-sub-header"><a href="/pandora/guide/monitor/metrics.html#aggregate-metric" class="sidebar-link">Aggregate metric</a></li></ul></li><li><a href="/pandora/guide/monitor/report.html" class="sidebar-link">Monitoring Data Report</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Monitoring Data Collection</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/guide/collect/health.html" class="sidebar-link">Health Check</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Extension</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pandora/guide/other/typescript.html" class="sidebar-link">Start A TypeScript Project</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="metrics-usage-and-extension"><a href="#metrics-usage-and-extension" aria-hidden="true" class="header-anchor">#</a> Metrics Usage and Extension</h1> <p>The Metrics is a big part of the whole monitoring system, which is based on EndPoint system to transport data, and simplified it to use.</p> <p>the Metrics original design is refer to a indicator, that value has used to feedback the current status of the application. so the value of the Metrics all is a number.</p> <p>In the industry, the Metrics have few standard types:</p> <ul><li>Gauge - Transient value</li> <li>Counter - Counter</li> <li>Meter - Meter</li> <li>histogram - Histogram</li></ul> <p>the Pandora.js has currently made certain support for these metrics types, the most common used are the gauge type and the counter type, 80% of the situations are only used these two.</p> <h2 id="quick-use"><a href="#quick-use" aria-hidden="true" class="header-anchor">#</a> Quick use</h2> <p>We set up a <code>MetricsClient</code> client at the start of each process, but how the user gets it this object has become a problem. We designed a proxy class called  <code>MetricsClientUtil</code>, you can get this class anywhere, for example:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>MetricsClientUtil<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dorapan'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> MetricsClientUtil<span class="token punctuation">.</span><span class="token function">getMetricsClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">let</span> counter <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test.qps.counter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> histogram <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getHistogram</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test.qps.histogram'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> meter <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getMeter</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test.qps.meter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> timer <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getTimer</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test.qps.timer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
counter<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
counter<span class="token punctuation">.</span><span class="token function">dec</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
histogram<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
meter<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We can easily to embed a Metrics indicator in anywhere through get a corresponding metrics method. you can open <code>/metrics/:group</code> to see the result of that Metrics you just did. More route methods for reference <a href="/pandora/monitor/resource.html">Reource</a>.</p> <blockquote><p>Notice: All metric instances, all must be registered to the MetricsClient in order to be collected.</p></blockquote> <p>Because of the specific nature of the Gauge indicator, The Client cannot be created like <code>getGauge</code>. In this case, you can out the <code>register()</code> method. The definition show in below, and you can also <a href="http://www.midwayjs.org/pandora/api-reference/metrics/classes/metricsclient.html#register" target="_blank" rel="noopener noreferrer">see the API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>client<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>group<span class="token punctuation">:</span> string<span class="token punctuation">,</span> name<span class="token punctuation">:</span> MetricName <span class="token operator">|</span> string<span class="token punctuation">,</span> Metric<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>By the design, we can add a Gauge type indicator like below:</p> <div class="language- extra-class"><pre class="language-text"><code>client.register('test', name, {
  getValue() {
  	return 100;
  }
});
</code></pre></div><h2 id="the-name-of-the-indicator-metricname"><a href="#the-name-of-the-indicator-metricname" aria-hidden="true" class="header-anchor">#</a> The name of the indicator - MetricName</h2> <p>Each indicator can have a name, this name in the Pandora.js it not a simple string, but a MetricName type object.</p> <p><a href="http://www.midwayjs.org/pandora/api-reference/metrics/classes/metricname.html" target="_blank" rel="noopener noreferrer">The reference the MetricName type<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>The most common are the key and the tags.</p> <p>The key is a normal string, joined by few strings with the separator dot(.),  and the tags is a K/V object.  the key and the tags identified a unique Metric.</p> <h2 id="measurement-type"><a href="#measurement-type" aria-hidden="true" class="header-anchor">#</a> Measurement type</h2> <blockquote><p>Pandora.js is written by Typescript, and some code must be defined with type.</p> <p>All metric types are inherited with <a href="http://www.midwayjs.org/pandora/api-reference/metrics/interfaces/metric.html" target="_blank" rel="noopener noreferrer">Metric Interface<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h3 id="transient-metric"><a href="#transient-metric" aria-hidden="true" class="header-anchor">#</a> Transient metric</h3> <p>Most of the indicators are introduced from the transient gauge because it is the simplest, the most visual representation of the actual situation of data, nor the question of the time interval.</p> <p>Gauge contains only one method called <code>getValue</code>, only implement this method when you want to use it. For example, if you want to know how the cpu of the current process works, you can solve it by Gauge.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>BaseGauge<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">const</span> startUsage <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cpuUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> startUsage<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Notice that all Metrics final output must be in the digital form, so that can be measured, if you want to output information about the string class, we have another output system, this will be introduced in the EndPoint.</p></blockquote> <h3 id="accumulative-metric"><a href="#accumulative-metric" aria-hidden="true" class="header-anchor">#</a> Accumulative metric</h3> <p>Counter is the second introduction of the type, the counter is not the same with the Gauge, which is a cumulative type, suitable for recording the total number of calls and other types of data, such as the number of calls to an interface.</p> <p>The following figure is the counter inheritance interface and implementation class.</p> <p><img src="https://img.alicdn.com/tfs/TB1OkX3ldrJ8KJjSspaXXXuKpXa-780-732.png" alt></p> <p>In addition to the basic <code>BaseCounter</code> implementation, we provide the <code>BucketCounter</code>.</p> <p>The principle of sub-bucket counting is to define a time interval, which is divided into several buckets according to the time interval for a period of time, and each bucket keeps a count of the current time interval.</p> <p>For example, the time interval is 5s, the total number of buckets is 10, then 0 ~ 5s is a bucket, 5 ~ 10s is the next one, and so on. When the counting execution time is 2s, then it will accumulate in the first bucket. If it is 7s, it will be accumulated in the second bucket, which is very easy to understand.</p> <p>In actual scenarios, it is not advisable to save too much because of memory limitations. The amount of buckets can be limited. Circular queue storage is used to avoid data movement.</p> <p>As a common example, record the number of koa service requests.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// The actual use needs to get BucketCounter from MetricsClient</span>
<span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BucketCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// add 1 counter.inc(1);</span>
  counter<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="distribution-metrics"><a href="#distribution-metrics" aria-hidden="true" class="header-anchor">#</a> Distribution metrics</h3> <p>The third one is the Histogram, a histogram of distributions. Pandora.js contains a <code>BaseHistogram</code> which can be used to count the response time of an interface and can show 50%, 70%, 90% of the request responses Time falls within which range you can calculate <a href="https://en.wikipedia.org/wiki/Apdex" target="_blank" rel="noopener noreferrer">Apdex<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <blockquote><p>The distribution here for the time being only consider the stand-alone distribution, in the cluster dimension can not be calculated in this way.</p></blockquote> <p>For distributed computing, the core is to maintain a data set <a href="http://www.midwayjs.org/pandora/api-reference/metrics/enums/reservoirtype.html" target="_blank" rel="noopener noreferrer">Reservoir<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, the data set is used to provide data storage and get the current snapshot Ability. The most important of these is the strategy of data updating. At present, Pandora.js only implements the realization of UniformReservoir and Exponentially Decaying Reservoir. Since random sampling does not perform well in weighting, the default is the index Attenuated random sampling, other sampling algorithms are not realized, interested students can add.</p> <p>Take a common example, record the success rate of koa services, the use of random sampling algorithm, an interval of 1s, 2 sub-barrel, show access to the average and other information.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// The actual use needs to get BaseHistogram from MetricsClient</span>
<span class="token keyword">let</span> histogram <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaseHistogram</span><span class="token punctuation">(</span>ReservoirType<span class="token punctuation">.</span><span class="token constant">UNIFORM</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  histogram<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  histogram<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// other biz</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// let snapshot = histogram.getSnapshot();</span>
<span class="token comment">// expect(snapshot.getMean()).to.equal(15);</span>
<span class="token comment">// expect(snapshot.getMax()).to.equal(20);</span>
<span class="token comment">// expect(snapshot.getMin()).to.equal(10);</span>
<span class="token comment">// expect(snapshot.getMedian()).to.equal(15);</span>
</code></pre></div><h3 id="rate-metric"><a href="#rate-metric" aria-hidden="true" class="header-anchor">#</a> Rate metric</h3> <p>The fourth one, Meter, is a gauge that measures throughput over a period of time. For example, one minute, five minutes, fifteen minutes qps indicator.</p> <p>Here we should point out that the rate of change, we generally care about two places, one is instantaneous burst, beyond the usual normal very high such fluctuations, and the other is a trend over time, from an average point of view A measure of the overall measure, this approach will be the average point of view.</p> <p>The former concept of using Rate in Metrics only records the cumulative total number of events. There is an external system to calculate the instantaneous rate by taking acquisitions twice before and after, which is what we call <code>Rate</code> here.</p> <p>In the calculation of rate, we think the data growth is <code>linear</code>. It is calculated as: rate = (v2 - v1) / (t2 - t1), where the unit of time is s.</p> <p>The benefit of this is that by adjusting the acquisition frequency, instantaneous rate calculations can be supported at any time interval. But the downside is that when the system reboots between samples, a negative number is calculated and some of the data is lost.</p> <p>The latter is calculated by the Exponential Weighted Moving Average (EWMA).</p> <p>For rate-based metrics, we provide 1 minute (m1), 5 minutes (m5) and 15 minutes of EWMA (m15) to reflect the rate changes of 1 minute, 5 minutes and 15 minutes respectively from the current time point.</p> <p>The specific method of calculation, and Linux system load1, load5, load15 calculation method is exactly the same. That is, the instantaneous rate is counted every 5 seconds and applied to the following recurrence formula:</p> <div class="language- extra-class"><pre class="language-text"><code>EWMA(t) = EWMA(t-1) + alpha * (instantRate - EWMA(t-1))
</code></pre></div><p>The alpha value ranges from 0 to 1, which is called the attenuation coefficient. The larger this coefficient is, the faster the weight of the older data decays from the current time point.</p> <p>Take a common example, record koa routing of a call rate.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Actual use needs to get BaseMeter from MetricsClient</span>
<span class="token keyword">let</span> meter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaseMeter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  meter<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// meter.getMeanRate(); Divide the total by time</span>
<span class="token comment">// meter.getOneMinuteRate(); // One minute EWMA</span>
</code></pre></div><h2 id="aggregate-metric"><a href="#aggregate-metric" aria-hidden="true" class="header-anchor">#</a> Aggregate metric</h2> <p>Here to introduce a special indicator, he is equivalent to the aggregation of multiple indicators.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> abstract <span class="token keyword">class</span> <span class="token class-name">MetricSet</span> <span class="token keyword">implements</span> <span class="token class-name">Metric</span> <span class="token punctuation">{</span>

  type<span class="token punctuation">:</span> string <span class="token operator">=</span> MetricType<span class="token punctuation">.</span><span class="token constant">METRICSET</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * A map of metric names to metrics.
   *
   * @return the metrics
   */</span>
  abstract <span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token punctuation">{</span>
    name<span class="token punctuation">,</span>
    metric
  <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>MetricSet contains an abstract <code>getMetrics ()</code> method that returns the final multiple Metrics, and we use it to implement an upper <code>CachedMetricSet</code> that caches metrics for different periods of MetricsLevel.</p> <p>Here's a simple example:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">TestCachedMetricSet</span> <span class="token keyword">extends</span> <span class="token class-name">CachedMetricSet</span> <span class="token punctuation">{</span>

  caches<span class="token punctuation">;</span>

  <span class="token function">getValueInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>caches <span class="token operator">=</span> <span class="token punctuation">{</span>
      a<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      b<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> MetricName<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string">'test.a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      metric<span class="token punctuation">:</span> <span class="token operator">&lt;</span>BaseGauge<span class="token operator">&lt;</span>any<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">async</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> self<span class="token punctuation">.</span><span class="token function">refreshIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> self<span class="token punctuation">.</span>caches<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> MetricName<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string">'test.b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      metric<span class="token punctuation">:</span> <span class="token operator">&lt;</span>GaugeProxy<span class="token operator">&lt;</span>any<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">async</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> self<span class="token punctuation">.</span><span class="token function">refreshIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> self<span class="token punctuation">.</span>caches<span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> results<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>Two Gauge metrics are returned via the <code>getMetrics ()</code> method. These two metrics are returned by the value of the internal cache. <code>RefreshIfNecessary ()</code> is used to refresh the internal cache value.</p> <p>Most of the built-in metrics such as CPU, memory, etc., are based on <code>CachedMetricSet</code>, for more on <a href="http://www.midwayjs.org/pandora/api-reference/metrics/classes/cpuusagegaugeset.html" target="_blank" rel="noopener noreferrer">code<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <blockquote><p>Although registration is an indicator, the final display is broken down into several separate metrics.</p></blockquote></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/midwayjs/pandora/edit/master/docs/guide/monitor/metrics.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/19/2018, 2:35:44 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pandora/guide/monitor/endpoint.html" class="prev">
          EndPoint Usage and Extension
        </a></span> <span class="next"><a href="/pandora/guide/monitor/report.html">
          Monitoring Data Report
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/pandora/assets/js/16.beaa5f2a.js" defer></script><script src="/pandora/assets/js/app.e1a5d135.js" defer></script>
  </body>
</html>
