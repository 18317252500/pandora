<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <title>自定义 Service - Ready to boot</title>
  <meta charset="utf-8">
  <meta name="description" content="index.description">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" href="/images/favicon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" href="/css/index.css">

</head>
<body>
  <div class="nav" >
  <header>
    <a href="/zh-cn/" class="nav-logo leftpadding" alt="egg"><img src="/images/nav-logo.png"> Pandora.js</a>
    <ul class="nav-item">
      <li><a href="/zh-cn/introduce.html" alt="文档指南">文档指南</a></li><li><a href="/zh-cn/api.html" alt="API 接口">API 接口</a></li><li><a href="https://github.com/midwayjs/pandora/releases" alt="发布日志">发布日志</a></li>
      <!--
      <li class="translations">
        <a class="nav-link">header.translations</a>
        <span class="arrow"></span>
        <ul class="dropdown-content">
          <li><a href="/">中文</a></li>
          <li><a href="/">English</a></li>
        </ul>
      </li>
      -->
      <li><iframe src="https://ghbtns.com/github-btn.html?user=midwayjs&repo=pandora&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container" class="container">
    <div class="page-main">
  <article class="markdown-body">
    <h1>自定义 Service</h1>
    <h2 id="什么是-service"><a class="markdown-anchor" href="#什么是-service">#</a> 什么是 Service</h2>
<p>Service 也是像 <code>process('x).entry('./y.js')</code> 一样，往进程里定义 Node.js 程序，不过更结构化，提供下面的基础能力：</p>
<ol>
<li>标准的 <code>async start()</code> 接口，用户可以异步的启动 Node.js 程序。</li>
<li>标准的 <code>async stop()</code> 接口，用户可以优雅的下线 Node.js 程序（比如优雅下线 RPC 服务，从而避免出现服务闪断）。</li>
<li>结构化的日志管理、配置能力。</li>
<li>进程内的启动顺序（依赖关系）管理。</li>
</ol>
<h2 id="如何获取-service"><a class="markdown-anchor" href="#如何获取-service">#</a> 如何获取 Service</h2>
<ol>
<li>一般用户可以通过 <code>require('pandora).getService(serviceName)</code> 获得。</li>
<li>Service 构造器中传入的 ServiceContext 亦有此方法。</li>
</ol>
<h2 id="如何定义-service"><a class="markdown-anchor" href="#如何定义-service">#</a> 如何定义 Service</h2>
<p>Process 在 procfile.js 中进行定义，依靠如下语法：</p>
<p><code>procfile.js</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">pandora</span>) </span>&#123;</span><br><span class="line">  pandora</span><br><span class="line">    .service(<span class="string">'serviceName'</span>, <span class="string">'./service.js'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的 <code>pandora. service('serviceName', './service.js')</code> 表示定义一个名字叫 <code>serviceName</code> 的 Service，并定义该 Service 的实现在 <code>./service.js</code>。</p>
<p>第二个参数除了传递一个相对路境外，也可以直接传递一个实现类的引用。最终，该语句会返回一个对象 <code>ServiceRepresentationChainModifier</code>。</p>
<p>我们可以通过 <code>ServiceRepresentationChainModifier</code> 完善对这个 Service 的定义。</p>
<p>下面通过一个简单的例子介绍全部的定义能力：</p>
<p><code>procfile.js</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">pandora</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 定义一个叫 serviceA 的 Service </span></span><br><span class="line">  <span class="comment">// 第二个参数为具体实现，可以是一个地址，或者一个实现类的引用</span></span><br><span class="line">  <span class="comment">// 如果不传第二参数，则是对已经定义的进行修改</span></span><br><span class="line">  pandora(<span class="string">'serviceA'</span>, <span class="string">'./ServiceA'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重命名 Service</span></span><br><span class="line">    <span class="comment">// 不传参数则获取</span></span><br><span class="line">    .name(<span class="string">'renameIt'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定分配到的进程，默认是 worker。</span></span><br><span class="line">    <span class="comment">// 可以用 pandora.defaultServiceCategory('worker') 修改默认取值</span></span><br><span class="line">    <span class="comment">// 不传参数则获取</span></span><br><span class="line">    .process(<span class="string">'worker'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向 Service 配置</span></span><br><span class="line">    <span class="comment">// 不传参数则获取</span></span><br><span class="line">    .config(&#123;</span><br><span class="line">      port: <span class="number">5555</span></span><br><span class="line">    &#125;)</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 定义依赖，下面的意思是，serviceX 必须先与此 Service 启动</span></span><br><span class="line">    <span class="comment">// 不传参数则获取</span></span><br><span class="line">    .dependency([<span class="string">'serviceX'</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在 IPC-Hub 中发布该 Service，具体参考 《进程间通信》 章节</span></span><br><span class="line">    <span class="comment">// . publish(false) 为取消发布</span></span><br><span class="line">    .publish()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Drop（删除）该 Service 定义</span></span><br><span class="line">    .drop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="seriveprocessprocessname-string-的取值"><a class="markdown-anchor" href="#seriveprocessprocessname-string-的取值">#</a> serive().process(processName: string) 的取值</h3>
<p><code>service().process(processName: string)</code> 里面的 <code>processName</code> 可以有如下的取值：</p>
<ol>
<li>某个已经定义了的进程名。</li>
<li>'weak-all'，所以已经激活了的进程（通过 entry 或者其他 Service），但自己不会激活任何进程。</li>
<li>'all'，全部定义了的进程。（会激活全部定义的进程，包括内置的默认定义，不建议使用）</li>
</ol>
<h3 id="修改默认分配到-process"><a class="markdown-anchor" href="#修改默认分配到-process">#</a> 修改默认分配到 Process</h3>
<p>使用上文提到的 <code>pandora.defaultServiceCategory()</code> 修改。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">pandora</span>) </span>&#123;</span><br><span class="line">  pandora.defaultServiceCategory(<span class="string">'processName'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="如何实现一个-service"><a class="markdown-anchor" href="#如何实现一个-service">#</a> 如何实现一个 Service</h2>
<p>每个 Service 都是一个 Class，这个 Class 需要实现 0 个必选接口，和 4 个可选接口。</p>
<p><strong>new (context: ServiceContextAccessor)</strong></p>
<blockquote>
<p>可选，构造器第一个参数为 ServiceContextAccessor 对象，该 Service 上下文对象，下面有介绍到。</p>
</blockquote>
<p><strong>start(): Promise&lt;void&gt; | void</strong></p>
<blockquote>
<p>可选，生命周期方法，启动服务。</p>
</blockquote>
<p><strong>stop?(): Promise&lt;void&gt; | void</strong></p>
<blockquote>
<p>可选，生命周期方法，停止服务。Pandora.js 在停止应用时给予 5 秒的时间窗口进行优雅退出。</p>
</blockquote>
<h4 id="静态属性-方法约束为"><a class="markdown-anchor" href="#静态属性-方法约束为">#</a> 静态属性、方法约束为：</h4>
<p><strong>dependencies: string[]</strong></p>
<blockquote>
<p>可选，在类系统中，亦称之为 static 属性。定义某个 Service 的依赖。</p>
</blockquote>
<h2 id="servicecontextaccessor-提供的主要接口"><a class="markdown-anchor" href="#servicecontextaccessor-提供的主要接口">#</a> ServiceContextAccessor 提供的主要接口</h2>
<p>这个上面有不少的属性和方法，具体参考 <code>ServiceContextAccessor</code> API。下面介绍几个常用的：</p>
<h4 id="主要的属性"><a class="markdown-anchor" href="#主要的属性">#</a> 主要的属性</h4>
<p><strong>serviceName: string</strong></p>
<blockquote>
<p>Service 的名字。</p>
</blockquote>
<p><strong>config: any</strong></p>
<blockquote>
<p>针对 Service 的配置，可以在 <code>.service().config({ key: 'value' })</code> 中给定。</p>
</blockquote>
<p><strong>dependencies: { [depName: string]: Service }</strong></p>
<blockquote>
<p>所有依赖的 Service 实例。</p>
</blockquote>
<p><strong>logger: ServiceLogger</strong></p>
<blockquote>
<p>Service 专有的日志对象，会记录日志文件至 <code>${logsDir}/${appName}/service.log</code> 。</p>
</blockquote>
<h3 id="如何单元测试"><a class="markdown-anchor" href="#如何单元测试">#</a> 如何单元测试</h3>
<p>你可以直接 new 你的实现类编写单元测试。</p>

  </article>
  <aside id="mobileAside" class="toc">
  <div class="mobile-menu">
    <ul><li><a href="/zh-cn/introduce.html" alt="文档指南">文档指南</a></li><li><a href="/zh-cn/api.html" alt="API 接口">API 接口</a></li><li><a href="https://github.com/midwayjs/pandora/releases" alt="发布日志">发布日志</a></li></ul>
  </div>
  <dl><dt><a href="/zh-cn/introduce.html">Pandora.js 是什么？</a></dt></ul></dd><dt><a href="/zh-cn/quickstart.html">快速入门</a></dt></ul></dd><dt><a href="/zh-cn/glossary.html">关键术语</a></dt></ul></dd><dt>基础功能</dt><dd><ul><li><a href="/zh-cn/base/command.html">命令行介绍</a></li><li><a href="/zh-cn/base/procfile_mode.html">认识 procfile.js</a></li><li><a href="/zh-cn/base/logs.html">日志管理</a></li><li><a href="/zh-cn/base/global_config.html">配置文件</a></li><li><a href="/zh-cn/base/monitor_inner.html">默认监控</a></li><li><a href="/zh-cn/base/debug.html">调试应用</a></li></ul></dd><dt>进程管理进阶</dt><dd><ul><li><a href="/zh-cn/process/process_std.html">自定义进程</a></li><li><a href="/zh-cn/process/service_std.html">自定义 Service</a></li><li><a href="/zh-cn/process/fork_and_cluster.html">Fork 和 Cluster</a></li><li><a href="/zh-cn/process/environment_std.html">自定义环境</a></li><li><a href="/zh-cn/process/application_life_cycle.html">应用生命周期</a></li><li><a href="/zh-cn/process/ipc_hub.html">进程间通信</a></li></ul></dd><dt>标准监控体系</dt><dd><ul><li><a href="/zh-cn/monitor/monitor_std.html">监控体系介绍</a></li><li><a href="/zh-cn/monitor/endpoint.html">使用和扩展 EndPoint</a></li><li><a href="/zh-cn/monitor/resource.html">对外暴露 Resource</a></li><li><a href="/zh-cn/monitor/metrics.html">使用和扩展 Metrics</a></li><li><a href="/zh-cn/monitor/trace.html">链路监控</a></li></ul></dd><dt>扩展功能</dt><dd><ul><li><a href="/zh-cn/other/dashboard.html">单机可视化管理面板</a></li><li><a href="/zh-cn/other/typescript.html">启动 TypeScript 项目</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');
mobileTrigger.onclick = function(e) {
  e.preventDefault();
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'toc';
  }
};
</script>

</div>

  </div>
</body>
<div class="cnzz">
<script src="https://s19.cnzz.com/z_stat.php?id=1271324644&web_id=1271324644" language="JavaScript"></script>
</div>

</html>
