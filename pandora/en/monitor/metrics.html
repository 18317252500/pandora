<!DOCTYPE html>
<html lang="en">
<head>
  <title>Metrics usage and extension - Ready to Boot</title>
  <meta charset="utf-8">
  <meta name="description" content="index.description">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" href="/pandora/css/index.css">

</head>
<body>
  <div class="nav" >
  <header>
    <a href="/pandora/en" class="nav-logo leftpadding" alt="Pandora.js"><img src="/pandora/images/nav-logo.png" > Pandora.js</a>
    <ul class="nav-item">
      <li><a href="/pandora/en/introduce.html" alt="Documentation">Documentation</a></li><li><a href="/pandora/en/api.html" alt="API reference">API reference</a></li><li><a href="https://github.com/midwayjs/pandora/releases" alt="Change Log">Change Log</a></li>
      <li class="translations">
        <a class="nav-link">English</a>
        <span class="arrow" style="border-top-color:#fff" ></span>
        <ul class="dropdown-content" >
          <li style="display: block; margin-left: 20px" ><a style="color: #008ce6" href="/pandora/zh-cn">中文</a></li>
          <li style="display: block; margin-left: 20px" ><a style="color: #008ce6" href="/pandora/en">English</a></li>
        </ul>
      </li>
      <li><iframe src="https://ghbtns.com/github-btn.html?user=midwayjs&repo=pandora&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container" class="container">
    <div class="page-main">
  <article class="markdown-body">
    <h1>Metrics usage and extension</h1>
    <p>The Metrics is a big part of the whole monitoring system, which is based on EndPoint system to transport data, and simplified it to use.</p>
<p>the Metrics original design is refer to a indicator, that value has used to feedback the current status of the application. so the value of the Metrics all is a number.</p>
<p>In the industry, the Metrics have few standard types:</p>
<ul>
<li>Gauge - Transient value</li>
<li>Counter - Counter</li>
<li>Meter - Meter</li>
<li>histogram - Histogram</li>
</ul>
<p>the Pandora.js has currently made certain support for these metrics types, the most common used are the gauge type and the counter type, 80% of the situations are only used these two.</p>
<h2 id="quick-use"><a class="markdown-anchor" href="#quick-use">#</a> Quick use</h2>
<p>We set up a <code>MetricsClient</code> client at the start of each process, but how the user gets it this object has become a problem. We designed a proxy class called  <code>MetricsClientUtil</code>, you can get this class anywhere, for example:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;MetricsClientUtil&#125; <span class="keyword">from</span> <span class="string">'dorapan'</span>;</span><br><span class="line"><span class="keyword">const</span> client = MetricsClientUtil.getMetricsClient();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">let</span> counter = client.getCounter(<span class="string">'test'</span>, <span class="string">'test.qps.counter'</span>);</span><br><span class="line"><span class="keyword">let</span> histogram = client.getHistogram(<span class="string">'test'</span>, <span class="string">'test.qps.histogram'</span>);</span><br><span class="line"><span class="keyword">let</span> meter = client.getMeter(<span class="string">'test'</span>, <span class="string">'test.qps.meter'</span>);</span><br><span class="line"><span class="keyword">let</span> timer = client.getTimer(<span class="string">'test'</span>, <span class="string">'test.qps.timer'</span>);</span><br><span class="line"> </span><br><span class="line">counter.inc(<span class="number">1</span>);</span><br><span class="line">counter.dec(<span class="number">1</span>);</span><br><span class="line">histogram.update(<span class="number">5</span>);</span><br><span class="line">meter.mark(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>We can easily to embed a Metrics indicator in anywhere through get a corresponding metrics method. you can open <code>/metrics/:group</code> to see the result of that Metrics you just did. More route methods for reference <a href="/monitor/resource.html">Reource</a>.</p>
<blockquote>
<p>Notice: All metric instances, all must be registered to the MetricsClient in order to be collected.</p>
</blockquote>
<p>Because of the specific nature of the Gauge indicator, The Client cannot be created like <code>getGauge</code>. In this case, you can out the <code>register()</code> method. The definition show in below, and you can also <a href="http://www.midwayjs.org/pandora/api-reference/metrics/classes/metricsclient.html#register" target="_blank" rel="noopener">see the API</a>.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">client.register(group: string, <span class="attr">name</span>: MetricName | string, Metric);</span><br></pre></td></tr></table></figure>
<p>By the design, we can add a Gauge type indicator like below:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">client.register(&apos;test&apos;, name, &#123;</span><br><span class="line">  getValue() &#123;</span><br><span class="line">  	return 100;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="the-name-of-the-indicator-metricname"><a class="markdown-anchor" href="#the-name-of-the-indicator-metricname">#</a> The name of the indicator - MetricName</h2>
<p>Each indicator can have a name, this name in the Pandora.js it not a simple string, but a MetricName type object.</p>
<p><a href="http://www.midwayjs.org/pandora/api-reference/metrics/classes/metricname.html" target="_blank" rel="noopener">The reference the MetricName type</a></p>
<p>The most common are the key and the tags.</p>
<p>The key is a normal string, joined by few strings with the separator dot(.),  and the tags is a K/V object.  the key and the tags identified a unique Metric.</p>
<p>And another part is the MetricsLevel, Different MetricsLevel corresponds to different indicator cache times, the default time is as follows, and the unit is seconds.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">getCachedTimeForLevel(level: MetricLevel) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (level) &#123;</span><br><span class="line">    <span class="keyword">case</span> MetricLevel.TRIVIAL:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">case</span> MetricLevel.MINOR:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">case</span> MetricLevel.NORMAL:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">case</span> MetricLevel.MAJOR:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">case</span> MetricLevel.CRITICAL:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">50</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>That also means, if your MetricsLevel is <code>MetricLevel.MAJOR</code>, then the cache time is seconds. If your acquisition interval is 1 second, then the value returned in both the acquisition windows is the same.</p>
<h2 id="measurement-type"><a class="markdown-anchor" href="#measurement-type">#</a> Measurement type</h2>
<blockquote>
<p>Pandora.js is written by Typescript, and some code must be defined with type.</p>
<p>All metric types are inherited with <a href="http://www.midwayjs.org/pandora/api-reference/metrics/interfaces/metric.html" target="_blank" rel="noopener">Metric Interface</a></p>
</blockquote>
<h3 id="transient-metric"><a class="markdown-anchor" href="#transient-metric">#</a> Transient metric</h3>
<p>Most of the indicators are introduced from the transient gauge because it is the simplest, the most visual representation of the actual situation of data, nor the question of the time interval.</p>
<p>Gauge contains only one method called <code>getValue</code>, only implement this method when you want to use it. For example, if you want to know how the cpu of the current process works, you can solve it by Gauge.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;BaseGauge&gt; &#123;</span><br><span class="line">  getValue() &#123;</span><br><span class="line">  	<span class="keyword">const</span> startUsage = process.cpuUsage();</span><br><span class="line">    <span class="keyword">return</span> startUsage.user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notice that all Metrics final output must be in the digital form, so that can be measured, if you want to output information about the string class, we have another output system, this will be introduced in the EndPoint.</p>
</blockquote>
<h3 id="accumulative-metric"><a class="markdown-anchor" href="#accumulative-metric">#</a> Accumulative metric</h3>
<p>Counter is the second introduction of the type, the counter is not the same with the Gauge, which is a cumulative type, suitable for recording the total number of calls and other types of data, such as the number of calls to an interface.</p>
<p>The following figure is the counter inheritance interface and implementation class.</p>
<p><img src="https://img.alicdn.com/tfs/TB1OkX3ldrJ8KJjSspaXXXuKpXa-780-732.png" alt=""></p>
<p>In addition to the basic <code>BaseCounter</code> implementation, we provide the <code>BucketCounter</code>.</p>
<p>The principle of sub-bucket counting is to define a time interval, which is divided into several buckets according to the time interval for a period of time, and each bucket keeps a count of the current time interval.</p>
<p>For example, the time interval is 5s, the total number of buckets is 10, then 0 ~ 5s is a bucket, 5 ~ 10s is the next one, and so on. When the counting execution time is 2s, then it will accumulate in the first bucket. If it is 7s, it will be accumulated in the second bucket, which is very easy to understand.</p>
<p>In actual scenarios, it is not advisable to save too much because of memory limitations. The amount of buckets can be limited. Circular queue storage is used to avoid data movement.</p>
<p>As a common example, record the number of koa service requests.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The actual use needs to get BucketCounter from MetricsClient</span></span><br><span class="line"><span class="keyword">let</span> counter = <span class="keyword">new</span> BucketCounter();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="comment">// add 1 counter.inc(1);</span></span><br><span class="line">  counter.inc();</span><br><span class="line">  <span class="keyword">await</span> next()</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="distribution-metrics"><a class="markdown-anchor" href="#distribution-metrics">#</a> Distribution metrics</h3>
<p>The third one is the Histogram, a histogram of distributions. Pandora.js contains a <code>BaseHistogram</code> which can be used to count the response time of an interface and can show 50%, 70%, 90% of the request responses Time falls within which range you can calculate <a href="https://en.wikipedia.org/wiki/Apdex" target="_blank" rel="noopener">Apdex</a>.</p>
<blockquote>
<p>The distribution here for the time being only consider the stand-alone distribution, in the cluster dimension can not be calculated in this way.</p>
</blockquote>
<p>For distributed computing, the core is to maintain a data set <a href="http://www.midwayjs.org/pandora/api-reference/metrics/enums/reservoirtype.html" target="_blank" rel="noopener">Reservoir</a>, the data set is used to provide data storage and get the current snapshot Ability. The most important of these is the strategy of data updating. At present, Pandora.js only implements the realization of UniformReservoir and Exponentially Decaying Reservoir. Since random sampling does not perform well in weighting, the default is the index Attenuated random sampling, other sampling algorithms are not realized, interested students can add.</p>
<p>Take a common example, record the success rate of koa services, the use of random sampling algorithm, an interval of 1s, 2 sub-barrel, show access to the average and other information.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The actual use needs to get BaseHistogram from MetricsClient</span></span><br><span class="line"><span class="keyword">let</span> histogram = <span class="keyword">new</span> BaseHistogram(ReservoirType.UNIFORM, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  histogram.update(<span class="number">10</span>);</span><br><span class="line">  histogram.update(<span class="number">20</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// other biz</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// let snapshot = histogram.getSnapshot();</span></span><br><span class="line"><span class="comment">// expect(snapshot.getMean()).to.equal(15);</span></span><br><span class="line"><span class="comment">// expect(snapshot.getMax()).to.equal(20);</span></span><br><span class="line"><span class="comment">// expect(snapshot.getMin()).to.equal(10);</span></span><br><span class="line"><span class="comment">// expect(snapshot.getMedian()).to.equal(15);</span></span><br></pre></td></tr></table></figure>
<h3 id="rate-metric"><a class="markdown-anchor" href="#rate-metric">#</a> Rate metric</h3>
<p>The fourth one, Meter, is a gauge that measures throughput over a period of time. For example, one minute, five minutes, fifteen minutes qps indicator.</p>
<p>Here we should point out that the rate of change, we generally care about two places, one is instantaneous burst, beyond the usual normal very high such fluctuations, and the other is a trend over time, from an average point of view A measure of the overall measure, this approach will be the average point of view.</p>
<p>The former concept of using Rate in Metrics only records the cumulative total number of events. There is an external system to calculate the instantaneous rate by taking acquisitions twice before and after, which is what we call <code>Rate</code> here.</p>
<p>In the calculation of rate, we think the data growth is <code>linear</code>. It is calculated as: rate = (v2 - v1) / (t2 - t1), where the unit of time is s.</p>
<p>The benefit of this is that by adjusting the acquisition frequency, instantaneous rate calculations can be supported at any time interval. But the downside is that when the system reboots between samples, a negative number is calculated and some of the data is lost.</p>
<p>The latter is calculated by the Exponential Weighted Moving Average (EWMA).</p>
<p>For rate-based metrics, we provide 1 minute (m1), 5 minutes (m5) and 15 minutes of EWMA (m15) to reflect the rate changes of 1 minute, 5 minutes and 15 minutes respectively from the current time point.</p>
<p>The specific method of calculation, and Linux system load1, load5, load15 calculation method is exactly the same. That is, the instantaneous rate is counted every 5 seconds and applied to the following recurrence formula:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EWMA(t) = EWMA(t-1) + alpha * (instantRate - EWMA(t-1))</span><br></pre></td></tr></table></figure>
<p>The alpha value ranges from 0 to 1, which is called the attenuation coefficient. The larger this coefficient is, the faster the weight of the older data decays from the current time point.</p>
<p>Take a common example, record koa routing of a call rate.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Actual use needs to get BaseMeter from MetricsClient</span></span><br><span class="line"><span class="keyword">let</span> meter = <span class="keyword">new</span> BaseMeter();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/home'</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  meter.mark(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// meter.getMeanRate(); Divide the total by time</span></span><br><span class="line"><span class="comment">// meter.getOneMinuteRate(); // One minute EWMA</span></span><br></pre></td></tr></table></figure>
<h2 id="aggregate-metric"><a class="markdown-anchor" href="#aggregate-metric">#</a> Aggregate metric</h2>
<p>Here to introduce a special indicator, he is equivalent to the aggregation of multiple indicators.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> abstract <span class="class"><span class="keyword">class</span> <span class="title">MetricSet</span> <span class="title">implements</span> <span class="title">Metric</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  type: string = MetricType.METRICSET;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A map of metric names to metrics.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @return the metrics</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  abstract getMetrics(): <span class="built_in">Array</span>&lt;&#123;</span><br><span class="line">    name,</span><br><span class="line">    metric</span><br><span class="line">  &#125;&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MetricSet contains an abstract <code>getMetrics ()</code> method that returns the final multiple Metrics, and we use it to implement an upper <code>CachedMetricSet</code> that caches metrics for different periods of MetricsLevel.</p>
<p>Here's a simple example:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestCachedMetricSet</span> <span class="keyword">extends</span> <span class="title">CachedMetricSet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  caches;</span><br><span class="line"></span><br><span class="line">  getValueInternal() &#123;</span><br><span class="line">    <span class="keyword">this</span>.caches = &#123;</span><br><span class="line">      a: <span class="built_in">Math</span>.random(),</span><br><span class="line">      b: <span class="built_in">Math</span>.random(),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getMetrics() &#123;</span><br><span class="line">    <span class="keyword">let</span> results = [];</span><br><span class="line">    <span class="keyword">let</span> self = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    results.push(&#123;</span><br><span class="line">      name: MetricName.build(<span class="string">'test.a'</span>),</span><br><span class="line">      metric: &lt;BaseGauge&lt;any&gt;&gt; &#123;</span><br><span class="line">        async getValue() &#123;</span><br><span class="line">          await self.refreshIfNecessary();</span><br><span class="line">          return self.caches['a'];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    results.push(&#123;</span><br><span class="line">      name: MetricName.build('test.b'),</span><br><span class="line">      metric: &lt;GaugeProxy&lt;any&gt;&gt; &#123;</span><br><span class="line">        async getValue() &#123;</span><br><span class="line">          await self.refreshIfNecessary();</span><br><span class="line">          return self.caches['b'];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return results;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Two Gauge metrics are returned via the <code>getMetrics ()</code> method. These two metrics are returned by the value of the internal cache. <code>RefreshIfNecessary ()</code> is used to refresh the internal cache value.</p>
<p>Most of the built-in metrics such as CPU, memory, etc., are based on <code>CachedMetricSet</code>, for more on <a href="http://www.midwayjs.org/pandora/api-reference/metrics/classes/cpuusagegaugeset.html" target="_blank" rel="noopener">code</a>.</p>
<blockquote>
<p>Although registration is an indicator, the final display is broken down into several separate metrics.</p>
</blockquote>

  </article>
  <aside id="mobileAside" class="toc">
  <div class="mobile-menu">
    <ul><li><a href="/pandora/en/introduce.html" alt="Documentation">Documentation</a></li><li><a href="/pandora/en/api.html" alt="API reference">API reference</a></li><li><a href="https://github.com/midwayjs/pandora/releases" alt="Change Log">Change Log</a></li></ul>
  </div>
  <dl><dt><a href="/pandora/en/introduce.html">What is the Pandora.js</a></dt></ul></dd><dt><a href="/pandora/en/quickstart.html">Quick Start</a></dt></ul></dd><dt><a href="/pandora/en/glossary.html">Glossary</a></dt></ul></dd><dt>Basic Features</dt><dd><ul><li><a href="/pandora/en/base/command.html">Commands</a></li><li><a href="/pandora/en/base/procfile_mode.html">Understand procfile.js</a></li><li><a href="/pandora/en/base/dorapan.html">User SDK - Dorapan</a></li><li><a href="/pandora/en/base/logs.html">Logger</a></li><li><a href="/pandora/en/base/global_config.html">Global Config</a></li><li><a href="/pandora/en/base/quick_monitor.html">Monitoring Quick Start</a></li><li><a href="/pandora/en/base/debug.html">Debugging</a></li></ul></dd><dt>Advanced Processes Model</dt><dd><ul><li><a href="/pandora/en/process/process_std.html">Custom Process</a></li><li><a href="/pandora/en/process/service_std.html">Custom Service</a></li><li><a href="/pandora/en/process/fork_and_cluster.html">Fork And Cluster</a></li><li><a href="/pandora/en/process/environment_std.html">Custom Environment</a></li><li><a href="/pandora/en/process/application_life_cycle.html">Application Life Cycle</a></li><li><a href="/pandora/en/process/ipc_hub.html">IPC-Hub</a></li></ul></dd><dt>Application Monitoring</dt><dd><ul><li><a href="/pandora/en/monitor/monitor_std.html">Overview of Monitoring</a></li><li><a href="/pandora/en/monitor/endpoint.html">EndPoint usage and extension</a></li><li><a href="/pandora/en/monitor/resource.html">Expose RESTFul API</a></li><li><a href="/pandora/en/monitor/metrics.html">Metrics usage and extension</a></li><li><a href="/pandora/en/monitor/trace.html">Trace business logic link</a></li><li><a href="/pandora/en/monitor/monitor_inner.html">Base Monitoring</a></li><li><a href="/pandora/en/monitor/report.html">Monitoring Data Report</a></li></ul></dd><dt>Monitoring Data Collection</dt><dd><ul><li><a href="/pandora/en/collect/health.html">Health Check</a></li></ul></dd><dt>Extension</dt><dd><ul><li><a href="/pandora/en/other/dashboard.html">GUI Dashboard</a></li><li><a href="/pandora/en/other/typescript.html">Start A TypeScript Project</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');
mobileTrigger.onclick = function(e) {
  e.preventDefault();
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'toc';
  }
};
</script>

</div>

  </div>
</body>
<div class="cnzz">
<script src="https://s19.cnzz.com/z_stat.php?id=1271324644&web_id=1271324644" language="JavaScript"></script>
</div>

</html>
